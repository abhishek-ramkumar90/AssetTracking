{"ast":null,"code":"/**\r\n * DevExtreme (core/utils/ajax.js)\r\n * Version: 19.2.7\r\n * Build date: Thu Mar 26 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar Deferred = require(\"./deferred\").Deferred;\n\nvar domAdapter = require(\"../../core/dom_adapter\");\n\nvar httpRequest = require(\"../../core/http_request\");\n\nvar windowUtils = require(\"../../core/utils/window\");\n\nvar window = windowUtils.getWindow();\n\nvar extendFromObject = require(\"./extend\").extendFromObject;\n\nvar isDefined = require(\"./type\").isDefined;\n\nvar Promise = require(\"../polyfills/promise\");\n\nvar injector = require(\"./dependency_injector\");\n\nvar SUCCESS = \"success\";\nvar ERROR = \"error\";\nvar TIMEOUT = \"timeout\";\nvar NO_CONTENT = \"nocontent\";\nvar PARSER_ERROR = \"parsererror\";\n\nvar isStatusSuccess = function (status) {\n  return 200 <= status && status < 300;\n};\n\nvar hasContent = function (status) {\n  return 204 !== status;\n};\n\nvar paramsConvert = function (params) {\n  var result = [];\n\n  for (var name in params) {\n    var value = params[name];\n\n    if (void 0 === value) {\n      continue;\n    }\n\n    if (null === value) {\n      value = \"\";\n    }\n\n    result.push(encodeURIComponent(name) + \"=\" + encodeURIComponent(value));\n  }\n\n  return result.join(\"&\");\n};\n\nvar createScript = function (options) {\n  var script = domAdapter.createElement(\"script\");\n\n  for (var name in options) {\n    script[name] = options[name];\n  }\n\n  return script;\n};\n\nvar removeScript = function (scriptNode) {\n  scriptNode.parentNode.removeChild(scriptNode);\n};\n\nvar appendToHead = function (element) {\n  return domAdapter.getHead().appendChild(element);\n};\n\nvar evalScript = function (code) {\n  var script = createScript({\n    text: code\n  });\n  appendToHead(script);\n  removeScript(script);\n};\n\nvar evalCrossDomainScript = function (url) {\n  var script = createScript({\n    src: url\n  });\n  return new Promise(function (resolve, reject) {\n    var events = {\n      load: resolve,\n      error: reject\n    };\n\n    var loadHandler = function (e) {\n      events[e.type]();\n      removeScript(script);\n    };\n\n    for (var event in events) {\n      domAdapter.listen(script, event, loadHandler);\n    }\n\n    appendToHead(script);\n  });\n};\n\nvar getAcceptHeader = function (options) {\n  var dataType = options.dataType || \"*\";\n  var scriptAccept = \"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript\";\n  var accepts = {\n    \"*\": \"*/*\",\n    text: \"text/plain\",\n    html: \"text/html\",\n    xml: \"application/xml, text/xml\",\n    json: \"application/json, text/javascript\",\n    jsonp: scriptAccept,\n    script: scriptAccept\n  };\n  extendFromObject(accepts, options.accepts, true);\n  return accepts[dataType] ? accepts[dataType] + (\"*\" !== dataType ? \", */*; q=0.01\" : \"\") : accepts[\"*\"];\n};\n\nvar getContentTypeHeader = function (options) {\n  var defaultContentType;\n\n  if (options.data && !options.upload && \"GET\" !== getMethod(options)) {\n    defaultContentType = \"application/x-www-form-urlencoded;charset=utf-8\";\n  }\n\n  return options.contentType || defaultContentType;\n};\n\nvar getDataFromResponse = function (xhr) {\n  return xhr.responseType && \"text\" !== xhr.responseType || \"string\" !== typeof xhr.responseText ? xhr.response : xhr.responseText;\n};\n\nvar postProcess = function (deferred, xhr, dataType) {\n  var data = getDataFromResponse(xhr);\n\n  switch (dataType) {\n    case \"jsonp\":\n      evalScript(data);\n      break;\n\n    case \"script\":\n      evalScript(data);\n      deferred.resolve(data, SUCCESS, xhr);\n      break;\n\n    case \"json\":\n      try {\n        deferred.resolve(JSON.parse(data), SUCCESS, xhr);\n      } catch (e) {\n        deferred.reject(xhr, PARSER_ERROR, e);\n      }\n\n      break;\n\n    default:\n      deferred.resolve(data, SUCCESS, xhr);\n  }\n};\n\nvar isCrossDomain = function (url) {\n  if (!windowUtils.hasWindow()) {\n    return true;\n  }\n\n  var crossDomain = false;\n  var originAnchor = domAdapter.createElement(\"a\");\n  var urlAnchor = domAdapter.createElement(\"a\");\n  originAnchor.href = window.location.href;\n\n  try {\n    urlAnchor.href = url;\n    urlAnchor.href = urlAnchor.href;\n    crossDomain = originAnchor.protocol + \"//\" + originAnchor.host !== urlAnchor.protocol + \"//\" + urlAnchor.host;\n  } catch (e) {\n    crossDomain = true;\n  }\n\n  return crossDomain;\n};\n\nvar setHttpTimeout = function (timeout, xhr) {\n  return timeout && setTimeout(function () {\n    xhr.customStatus = TIMEOUT;\n    xhr.abort();\n  }, timeout);\n};\n\nvar getJsonpOptions = function (options) {\n  if (\"jsonp\" === options.dataType) {\n    var random = Math.random().toString().replace(/\\D/g, \"\");\n    var callbackName = options.jsonpCallback || \"dxCallback\" + Date.now() + \"_\" + random;\n    var callbackParameter = options.jsonp || \"callback\";\n    options.data = options.data || {};\n    options.data[callbackParameter] = callbackName;\n    return callbackName;\n  }\n};\n\nvar getRequestOptions = function (options, headers) {\n  var params = options.data;\n  var paramsAlreadyString = \"string\" === typeof params;\n  var url = options.url || window.location.href;\n\n  if (!paramsAlreadyString && !options.cache) {\n    params = params || {};\n    params._ = Date.now();\n  }\n\n  if (params && !options.upload) {\n    if (!paramsAlreadyString) {\n      params = paramsConvert(params);\n    }\n\n    if (\"GET\" === getMethod(options)) {\n      if (\"\" !== params) {\n        url += (url.indexOf(\"?\") > -1 ? \"&\" : \"?\") + params;\n      }\n\n      params = null;\n    } else {\n      if (headers[\"Content-Type\"] && headers[\"Content-Type\"].indexOf(\"application/x-www-form-urlencoded\") > -1) {\n        params = params.replace(/%20/g, \"+\");\n      }\n    }\n  }\n\n  return {\n    url: url,\n    parameters: params\n  };\n};\n\nvar getMethod = function (options) {\n  return (options.method || \"GET\").toUpperCase();\n};\n\nvar getRequestHeaders = function (options) {\n  var headers = options.headers || {};\n  headers[\"Content-Type\"] = headers[\"Content-Type\"] || getContentTypeHeader(options);\n  headers.Accept = headers.Accept || getAcceptHeader(options);\n\n  if (!options.crossDomain && !headers[\"X-Requested-With\"]) {\n    headers[\"X-Requested-With\"] = \"XMLHttpRequest\";\n  }\n\n  return headers;\n};\n\nvar sendRequest = function (options) {\n  var xhr = httpRequest.getXhr();\n  var d = new Deferred();\n  var result = d.promise();\n  var async = isDefined(options.async) ? options.async : true;\n  var dataType = options.dataType;\n  var timeout = options.timeout || 0;\n  var timeoutId;\n  options.crossDomain = isCrossDomain(options.url);\n  var needScriptEvaluation = \"jsonp\" === dataType || \"script\" === dataType;\n\n  if (void 0 === options.cache) {\n    options.cache = !needScriptEvaluation;\n  }\n\n  var callbackName = getJsonpOptions(options);\n  var headers = getRequestHeaders(options);\n  var requestOptions = getRequestOptions(options, headers);\n  var url = requestOptions.url;\n  var parameters = requestOptions.parameters;\n\n  if (callbackName) {\n    window[callbackName] = function (data) {\n      d.resolve(data, SUCCESS, xhr);\n    };\n  }\n\n  if (options.crossDomain && needScriptEvaluation) {\n    var reject = function () {\n      d.reject(xhr, ERROR);\n    };\n\n    var resolve = function () {\n      if (\"jsonp\" === dataType) {\n        return;\n      }\n\n      d.resolve(null, SUCCESS, xhr);\n    };\n\n    evalCrossDomainScript(url).then(resolve, reject);\n    return result;\n  }\n\n  if (options.crossDomain && !(\"withCredentials\" in xhr)) {\n    d.reject(xhr, ERROR);\n    return result;\n  }\n\n  xhr.open(getMethod(options), url, async, options.username, options.password);\n\n  if (async) {\n    xhr.timeout = timeout;\n    timeoutId = setHttpTimeout(timeout, xhr, d);\n  }\n\n  xhr.onreadystatechange = function (e) {\n    if (4 === xhr.readyState) {\n      clearTimeout(timeoutId);\n\n      if (isStatusSuccess(xhr.status)) {\n        if (hasContent(xhr.status)) {\n          postProcess(d, xhr, dataType);\n        } else {\n          d.resolve(null, NO_CONTENT, xhr);\n        }\n      } else {\n        d.reject(xhr, xhr.customStatus || ERROR);\n      }\n    }\n  };\n\n  if (options.upload) {\n    xhr.upload.onprogress = options.upload.onprogress;\n    xhr.upload.onloadstart = options.upload.onloadstart;\n    xhr.upload.onabort = options.upload.onabort;\n  }\n\n  if (options.xhrFields) {\n    for (var field in options.xhrFields) {\n      xhr[field] = options.xhrFields[field];\n    }\n  }\n\n  if (\"arraybuffer\" === options.responseType) {\n    xhr.responseType = options.responseType;\n  }\n\n  for (var name in headers) {\n    if (Object.prototype.hasOwnProperty.call(headers, name) && isDefined(headers[name])) {\n      xhr.setRequestHeader(name, headers[name]);\n    }\n  }\n\n  if (options.beforeSend) {\n    options.beforeSend(xhr);\n  }\n\n  xhr.send(parameters);\n\n  result.abort = function () {\n    xhr.abort();\n  };\n\n  return result;\n};\n\nmodule.exports = injector({\n  sendRequest: sendRequest\n});","map":null,"metadata":{},"sourceType":"script"}